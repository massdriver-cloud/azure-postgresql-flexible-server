schema: draft-07
name: azure-postgres-flexible-server
description: "Azure PostgreSQL Flexible Server is a fully managed database service designed to provide more control and flexibility over database management functions and configurations."
ref: github.com/massdriver-cloud/azure-postgresql-flexible-server
access: "public"
type: bundle

steps:
  - path: src
    provisioner: terraform

params:
  examples:
    - __name: "Development"
      postgres_version: "13"
      size: "B2s (2 vCores, 4 GiB memory, 1280 max iops)"
      storage_mb: 32768
      backup_retention_days: 7
      high_availability: false
    - __name: "Production (Small / Medium-size)"
      postgres_version: "13"
      size: "D16s (16 vCores, 64 GiB memory, 18000 max iops)"
      storage_mb: 262144
      backup_retention_days: 30
      high_availability: true
    - __name: "Production (Large-size)"
      postgres_version: "13"
      size: "E32s (32 vCores, 256 GiB memory, 18000 max iops)"
      storage_mb: 524288
      backup_retention_days: 30
      high_availability: true
  required:
    - postgres_version
    - username
    - size
    - storage_mb
    - cidr
  properties:
    postgres_version:
      title: PostgreSQL version
      description: The version of PostgreSQL to use.
      type: string
      default: "13"
      enum:
        - "11"
        - "12"
        - "13"
    username:
      title: Username
      description: The administrator login for the PostgreSQL Flexible Server. (Cannot be 'admin', 'root', 'administrator', 'username', 'azure_superuser', 'azure_pg_admin', 'guest', or 'public'.)
      type: string
      not:
        enum:
          - admin
          - root
          - administrator
          - username
          - azure_superuser
          - azure_pg_admin
          - guest
          - public
    size:
      title: Compute size
      description: Select the amount of cores, memory, and iops you need for your workload (B = Burstable, D = General Purpose, E = Memory Optimized).
      type: string
      enum:
        - B1ms (1 vCore, 2 GiB memory, 640 max iops)
        - B2s (2 vCores, 4 GiB memory, 1280 max iops)
        - D2s (2 vCores, 8 GiB memory, 3200 max iops)
        - D4s (4 vCores, 16 GiB memory, 6400 max iops)
        - D8s (8 vCores, 32 GiB memory, 12800 max iops)
        - D16s (16 vCores, 64 GiB memory, 18000 max iops)
        - D32s (32 vCores, 128 GiB memory, 18000 max iops)
        - D48s (48 vCores, 192 GiB memory, 18000 max iops)
        - D64s (64 vCores, 256 GiB memory, 18000 max iops)
        - E2s (2 vCores, 16 GiB memory, 3200 max iops)
        - E4s (4 vCores, 32 GiB memory, 6400 max iops)
        - E8s (8 vCores, 64 GiB memory, 12800 max iops)
        - E16s (16 vCores, 128 GiB memory, 18000 max iops)
        - E32s (32 vCores, 256 GiB memory, 18000 max iops)
        - E48s (48 vCores, 384 GiB memory, 18000 max iops)
        - E64s (64 vCores, 432 GiB memory, 18000 max iops)
    storage_mb:
      title: Storage
      description: The amount of storage capacity available to your Azure Database for PostgreSQL server.
      type: integer
      oneOf:
        - title: 32GB
          const: 32768
        - title: 64GB
          const: 65536
        - title: 128GB
          const: 131072
        - title: 256GB
          const: 262144
        - title: 512GB
          const: 524288
        - title: 1TB
          const: 1048576
        - title: 2TB
          const: 2097152
        - title: 4TB
          const: 4194304
        - title: 8TB
          const: 8388608
        - title: 16TB
          const: 16777216
        - title: 32TB
          const: 33554432
    cidr:
      title: Subnet CIDR
      type: string
      description: Specify a /28 CIDR range within your vnet to create subnet for the database
      pattern: ^(?:10\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|172\.(?:1[6-9]|2[0-9]|3[0-1])|192\.168)(?:\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])){2}\/28$
      message:
        pattern: "Must be a /28 range from within the VNet CIDR"
    backup_retention_days:
      title: Backup Retention
      description: How many days to retain PostgreSQL database backups (minimum of 7, maximum of 35).
      type: integer
      default: 7
      minimum: 7
      maximum: 35
    high_availability:
      title: Enable High Availability
      description: Zone redundant high availability deploys a standby replica to a different zone for automatic failover in the event of an outage.
      type: boolean
      default: false

connections:
  required:
    - azure_service_principal
    - vnet
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    vnet:
      $ref: massdriver/azure-virtual-network

artifacts:
  required:
    - authentication
  properties:
    authentication:
      $ref: massdriver/postgresql-authentication

ui:
  ui:order:
    - postgres_version
    - tier
    - size
    - storage_mb
    - username
    - cidr
    - backup_retention_days
    - high_availability
